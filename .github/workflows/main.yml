name: synczb

# è§¦å‘æ¡ä»¶
on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 00:00 å’Œ 12:00 è¿è¡Œ
    - cron: '0 0/1 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - 'main.py'
      - '.github/workflows/main.yml'

permissions:
  contents: write  # ç¡®ä¿ GITHUB_TOKEN å…·æœ‰å†™å…¥æƒé™

jobs:
  fetch_and_process:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºé¡¹ç›®ä»“åº“
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

    # 2. è®¾ç½® Python ç¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    # 3. å®‰è£…ä¾èµ–
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    # 4. è¿è¡Œ Python è„šæœ¬
    - name: Run processing script
      run: |
        python main.py

    # 5. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ç”ŸæˆæˆåŠŸ
    - name: Verify generated files
      run: |
        echo "=== ç”Ÿæˆçš„æ–‡ä»¶ ==="
        ls -la my*.txt 2>/dev/null || echo "æœªæ‰¾åˆ°my*.txtæ–‡ä»¶"
        echo ""
        echo "=== æ–‡ä»¶é¢„è§ˆ ==="
        if [ -f "my1.txt" ]; then
          echo "my1.txt å‰3è¡Œ:"
          head -3 my1.txt
          echo ""
        fi
        if [ -f "my2.txt" ]; then
          echo "my2.txt å‰3è¡Œ:"
          head -3 my2.txt
          echo ""
        fi

    # 6. é…ç½® Git
    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    # 7. æäº¤æ›´æ”¹
    - name: Commit and Push changes
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
        if git diff --quiet --exit-code; then
          echo "æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
        else
          echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œæ­£åœ¨æäº¤..."
          
          # æ·»åŠ æ–‡ä»¶
          git add my1.txt my2.txt
          
          # åˆ›å»ºæäº¤ä¿¡æ¯
          commit_msg="ğŸ“º è‡ªåŠ¨æ›´æ–°IPTVæºæ–‡ä»¶ [$(date +'%Y-%m-%d %H:%M')]
          
          æ›´æ–°IPTVåˆ†ç±»æºæ–‡ä»¶ï¼š
          - my1.txt: æ–°èã€é¦™æ¸¯ç­‰ç±»åˆ«
          - my2.txt: ä½“è‚²ã€å°æ¹¾ç­‰ç±»åˆ«
          
          ç”±GitHub Actionsè‡ªåŠ¨æ‰§è¡Œ"
          
          git commit -m "$commit_msg"
          
          # æ‹‰å–æœ€æ–°æ›´æ”¹é¿å…å†²çª
          git pull --rebase origin main
          
          # æ¨é€æ›´æ”¹
          git push origin main
          
          echo "âœ… æ›´æ”¹å·²æäº¤å¹¶æ¨é€"
        fi

    # 8. ä¸Šä¼ å·¥ä»¶ï¼ˆå¯é€‰ï¼‰
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: iptv-files
        path: |
          my1.txt
          my2.txt
        retention-days: 7
