name: synczb

# 触发条件
on:
  schedule:
    # 每2小时运行一次
    - cron: '0 */2 * * *'
  workflow_dispatch: # 允许手动触发
  push: # 当代码有推送时也运行
    branches:
      - main
    paths:
      - '**.py'  # Python文件变更时触发

permissions:
  contents: write

jobs:
  fetch_streams:
    runs-on: ubuntu-latest

    steps:
    # 1. 检出项目仓库（不需要token）
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. 设置 Python 环境
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # 3. 安装依赖
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas requests

    # 4. 创建必要的目录
    - name: Create directories
      run: |
        mkdir -p TMP
        mkdir -p logs

    # 5. 运行 Python 脚本
    - name: Run main script
      run: |
        python main.py
        echo "Main script executed at $(date)" >> logs/execution.log

    # 6. 运行转换脚本
    - name: Run conversion script
      run: |
        python TMP/m3utotxt.py
        echo "Conversion script executed at $(date)" >> logs/execution.log

    # 7. 检查文件变化
    - name: Check file changes
      run: |
        echo "=== 文件变化检查 ==="
        echo "my1.txt 状态:"
        git status my1.txt --short || echo "文件不存在"
        echo ""
        echo "TMP/temp.txt 状态:"
        git status TMP/temp.txt --short || echo "文件不存在"
        echo ""
        echo "检查时间: $(date)" >> logs/execution.log

    # 8. 配置 Git 信息
    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    # 9. 准备提交（单次提交所有文件）
    - name: Prepare and commit changes
      run: |
        # 检查是否有任何文件变化
        if git diff --quiet && git diff --cached --quiet; then
          echo "没有文件变化，跳过提交"
          echo "no_changes=true" >> $GITHUB_ENV
        else
          echo "检测到文件变化，准备提交"
          
          # 添加所有变化的文件
          git add my1.txt TMP/temp.txt logs/execution.log
          
          # 生成提交信息
          COMMIT_MSG="Automated update: $(date +'%Y-%m-%d %H:%M:%S')"
          echo "提交信息: $COMMIT_MSG"
          
          # 提交
          git commit -m "$COMMIT_MSG"
          echo "no_changes=false" >> $GITHUB_ENV
        fi

    # 10. 推送更改
    - name: Push changes
      if: env.no_changes == 'false'
      run: |
        echo "开始推送更改到仓库..."
        git pull --rebase origin main
        git push origin main
        echo "推送完成时间: $(date)" >> logs/execution.log

    # 11. 输出文件统计信息
    - name: Output file statistics
      run: |
        echo "=== 输出文件统计 ==="
        if [ -f "my1.txt" ]; then
          echo "my1.txt:"
          echo "  行数: $(wc -l < my1.txt)"
          echo "  大小: $(du -h my1.txt | cut -f1)"
        fi
        
        if [ -f "TMP/temp.txt" ]; then
          echo "TMP/temp.txt:"
          echo "  行数: $(wc -l < TMP/temp.txt)"
          echo "  大小: $(du -h TMP/temp.txt | cut -f1)"
        fi

    # 12. 上传工件（可选）
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: generated-files-$(date +%Y%m%d-%H%M%S)
        path: |
          my1.txt
          TMP/temp.txt
          logs/
        retention-days: 5
